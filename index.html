
import asyncio
import logging
import json
import signal
import sys
import sqlite3
from datetime import datetime, timedelta
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import CommandStart, Command
from aiogram.types import WebAppInfo, InlineKeyboardButton, InlineKeyboardMarkup
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger

# --- Configuration ---
BOT_TOKEN = "6740270464:AAEqH_0_M288GVHqD1YwFAYPIa6wXRSYpHg"
WEB_APP_URL = "https://karos7777.github.io/bebe/"

# –í—Ä–µ–º—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10:00)
DAILY_NOTIFICATION_HOUR = 10
DAILY_NOTIFICATION_MINUTE = 0

# --- Logging ---
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# --- Database Setup ---
def init_database():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    conn = sqlite3.connect('countdown_bot.db')
    cursor = conn.cursor()
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS user_countdowns (
            user_id INTEGER PRIMARY KEY,
            username TEXT,
            full_name TEXT,
            start_date TEXT,
            end_date TEXT,
            total_days INTEGER,
            remaining_days INTEGER,
            notification_time TEXT,
            is_active BOOLEAN DEFAULT 1,
            created_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    conn.commit()
    conn.close()

def save_countdown(user_id, username, full_name, days, notification_time="10:00"):
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
    conn = sqlite3.connect('countdown_bot.db')
    cursor = conn.cursor()
    
    start_date = datetime.now()
    end_date = start_date + timedelta(days=days)
    
    cursor.execute('''
        INSERT OR REPLACE INTO user_countdowns 
        (user_id, username, full_name, start_date, end_date, total_days, remaining_days, notification_time, is_active)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, 1)
    ''', (
        user_id, username, full_name,
        start_date.isoformat(),
        end_date.isoformat(),
        days, days, notification_time
    ))
    
    conn.commit()
    conn.close()

def get_user_countdown(user_id):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    conn = sqlite3.connect('countdown_bot.db')
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT * FROM user_countdowns 
        WHERE user_id = ? AND is_active = 1
    ''', (user_id,))
    
    result = cursor.fetchone()
    conn.close()
    return result

def update_remaining_days(user_id, remaining_days):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –¥–Ω–µ–π"""
    conn = sqlite3.connect('countdown_bot.db')
    cursor = conn.cursor()
    
    if remaining_days <= 0:
        cursor.execute('''
            UPDATE user_countdowns 
            SET remaining_days = 0, is_active = 0
            WHERE user_id = ?
        ''', (user_id,))
    else:
        cursor.execute('''
            UPDATE user_countdowns 
            SET remaining_days = ?
            WHERE user_id = ?
        ''', (remaining_days, user_id))
    
    conn.commit()
    conn.close()

def get_active_countdowns():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤"""
    conn = sqlite3.connect('countdown_bot.db')
    cursor = conn.cursor()
    
    cursor.execute('''
        SELECT user_id, username, full_name, start_date, end_date, total_days, remaining_days, notification_time
        FROM user_countdowns 
        WHERE is_active = 1 AND remaining_days > 0
    ''')
    
    results = cursor.fetchall()
    conn.close()
    return results

def stop_countdown(user_id):
    """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—á–µ—Ç—á–∏–∫–∞"""
    conn = sqlite3.connect('countdown_bot.db')
    cursor = conn.cursor()
    
    cursor.execute('''
        UPDATE user_countdowns 
        SET is_active = 0
        WHERE user_id = ?
    ''', (user_id,))
    
    conn.commit()
    conn.close()

# --- Bot and Scheduler ---
bot = Bot(token=BOT_TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
dp = Dispatcher()
scheduler = AsyncIOScheduler()

# --- Helper Functions ---
def calculate_time_remaining(end_date_str):
    """–ü–æ–¥—Å—á–µ—Ç —Ç–æ—á–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ –∫–æ–Ω—Ü–∞"""
    end_date = datetime.fromisoformat(end_date_str)
    now = datetime.now()
    
    if now >= end_date:
        return 0, 0, 0, 0  # days, hours, minutes, seconds
    
    time_diff = end_date - now
    days = time_diff.days
    hours, remainder = divmod(time_diff.seconds, 3600)
    minutes, seconds = divmod(remainder, 60)
    
    return days, hours, minutes, seconds

def format_time_remaining(days, hours, minutes, seconds=None):
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥"""
    parts = []
    
    if days > 0:
        if days == 1:
            parts.append(f"{days} –¥–µ–Ω—å")
        elif 2 <= days <= 4:
            parts.append(f"{days} –¥–Ω—è")
        else:
            parts.append(f"{days} –¥–Ω–µ–π")
    
    if hours > 0:
        if hours == 1:
            parts.append(f"{hours} —á–∞—Å")
        elif 2 <= hours <= 4:
            parts.append(f"{hours} —á–∞—Å–∞")
        else:
            parts.append(f"{hours} —á–∞—Å–æ–≤")
    
    if minutes > 0:
        if minutes == 1:
            parts.append(f"{minutes} –º–∏–Ω—É—Ç–∞")
        elif 2 <= minutes <= 4:
            parts.append(f"{minutes} –º–∏–Ω—É—Ç—ã")
        else:
            parts.append(f"{minutes} –º–∏–Ω—É—Ç")
    
    if seconds is not None and len(parts) == 0:
        if seconds == 1:
            parts.append(f"{seconds} —Å–µ–∫—É–Ω–¥–∞")
        elif 2 <= seconds <= 4:
            parts.append(f"{seconds} —Å–µ–∫—É–Ω–¥—ã")
        else:
            parts.append(f"{seconds} —Å–µ–∫—É–Ω–¥")
    
    if not parts:
        return "–í—Ä–µ–º—è –≤—ã—à–ª–æ!"
    
    return " ".join(parts)

# --- Scheduled Tasks ---
async def daily_countdown_update():
    """–ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
    logger.info("–ó–∞–ø—É—Å–∫ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤...")
    
    active_countdowns = get_active_countdowns()
    
    for countdown in active_countdowns:
        user_id, username, full_name, start_date, end_date, total_days, remaining_days, notification_time = countdown
        
        try:
            days, hours, minutes, seconds = calculate_time_remaining(end_date)
            
            if days <= 0 and hours <= 0 and minutes <= 0:
                # –í—Ä–µ–º—è –≤—ã—à–ª–æ
                update_remaining_days(user_id, 0)
                message = (
                    "üéâ <b>–í—Ä–µ–º—è –≤—ã—à–ª–æ!</b>\n\n"
                    "–í–∞—à –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –ù–∞–¥–µ—é—Å—å, –≤—ã –¥–æ—Å—Ç–∏–≥–ª–∏ —Å–≤–æ–µ–π —Ü–µ–ª–∏!"
                )
                await bot.send_message(user_id, message)
            else:
                # –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –¥–Ω–∏
                update_remaining_days(user_id, days)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                time_remaining = format_time_remaining(days, hours, minutes)
                progress_bar = "‚ñà" * (10 - min(10, max(0, int((days / total_days) * 10))))
                progress_bar += "‚ñë" * (10 - len(progress_bar))
                
                message = (
                    f"‚è∞ <b>–ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</b>\n\n"
                    f"–î–æ –∫–æ–Ω—Ü–∞ –æ—Å—Ç–∞–ª–æ—Å—å:\n"
                    f"<b>{time_remaining}</b>\n\n"
                    f"–ü—Ä–æ–≥—Ä–µ—Å—Å: [{progress_bar}] {int(((total_days - days) / total_days) * 100)}%\n\n"
                    f"–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –¥–≤–∏–≥–∞—Ç—å—Å—è –∫ —Ü–µ–ª–∏! üí™"
                )
                
                # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                keyboard = InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(text="üìä –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data=f"stats_{user_id}")],
                    [InlineKeyboardButton(text="üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ç—Å—á–µ—Ç", callback_data=f"stop_{user_id}")]
                ])
                
                await bot.send_message(user_id, message, reply_markup=keyboard)
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—á–µ—Ç—á–∏–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")

# --- Handlers ---
@dp.message(CommandStart())
async def send_welcome(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    try:
        user_id = message.from_user.id
        username = message.from_user.username
        full_name = message.from_user.full_name
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —Å—á–µ—Ç—á–∏–∫
        countdown = get_user_countdown(user_id)
        
        if countdown:
            days, hours, minutes, seconds = calculate_time_remaining(countdown[4])  # end_date
            if days <= 0 and hours <= 0 and minutes <= 0:
                # –°—á–µ—Ç—á–∏–∫ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è
                update_remaining_days(user_id, 0)
                keyboard = InlineKeyboardMarkup(inline_keyboard=[[
                    InlineKeyboardButton(
                        text="üóìÔ∏è –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –æ—Ç—Å—á–µ—Ç",
                        web_app=WebAppInfo(url=WEB_APP_URL)
                    )
                ]])
                await message.answer(
                    f"–ü—Ä–∏–≤–µ—Ç, {full_name}!\n\n"
                    "–í–∞—à –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç—Å—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π!",
                    reply_markup=keyboard
                )
            else:
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—á–µ—Ç—á–∏–∫
                time_remaining = format_time_remaining(days, hours, minutes, seconds)
                keyboard = InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(text="üìä –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data=f"stats_{user_id}")],
                    [InlineKeyboardButton(text="üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ç—Å—á–µ—Ç", callback_data=f"stop_{user_id}")],
                    [InlineKeyboardButton(
                        text="üóìÔ∏è –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –æ—Ç—Å—á–µ—Ç",
                        web_app=WebAppInfo(url=WEB_APP_URL)
                    )]
                ])
                await message.answer(
                    f"–ü—Ä–∏–≤–µ—Ç, {full_name}!\n\n"
                    f"–£ –≤–∞—Å –∞–∫—Ç–∏–≤–µ–Ω –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç:\n"
                    f"<b>{time_remaining}</b>\n\n"
                    f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
                    reply_markup=keyboard
                )
        else:
            # –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –∏–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞
            web_app_button = InlineKeyboardButton(
                text="üóìÔ∏è –°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç",
                web_app=WebAppInfo(url=WEB_APP_URL)
            )
            keyboard = InlineKeyboardMarkup(inline_keyboard=[[web_app_button]])

            await message.answer(
                f"–ü—Ä–∏–≤–µ—Ç, {full_name}!\n\n"
                "–°–æ–∑–¥–∞–π—Ç–µ –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç –¥–æ –≤–∞–∂–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è!\n"
                "–Ø –±—É–¥—É –ø—Ä–∏—Å—ã–ª–∞—Ç—å –≤–∞–º –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å —Ç–æ—á–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º –¥–æ —Ü–µ–ª–∏.",
                reply_markup=keyboard
            )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ send_welcome: {e}")
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")

@dp.message(Command("status"))
async def show_status(message: types.Message):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –æ—Ç—Å—á–µ—Ç–∞"""
    try:
        user_id = message.from_user.id
        countdown = get_user_countdown(user_id)
        
        if not countdown:
            await message.answer(
                "–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞.\n"
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π."
            )
            return
        
        days, hours, minutes, seconds = calculate_time_remaining(countdown[4])
        
        if days <= 0 and hours <= 0 and minutes <= 0:
            await message.answer("üéâ –í–∞—à –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!")
            update_remaining_days(user_id, 0)
            return
        
        time_remaining = format_time_remaining(days, hours, minutes, seconds)
        total_days = countdown[5]
        progress = int(((total_days - days) / total_days) * 100)
        
        await message.answer(
            f"üìä <b>–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –æ—Ç—Å—á–µ—Ç–∞:</b>\n\n"
            f"‚è∞ –û—Å—Ç–∞–ª–æ—Å—å: <b>{time_remaining}</b>\n"
            f"üìÖ –í—Å–µ–≥–æ –¥–Ω–µ–π: {total_days}\n"
            f"üìà –ü—Ä–æ–≥—Ä–µ—Å—Å: {progress}%\n"
            f"üïô –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {countdown[7]}"
        )
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ show_status: {e}")
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞.")

@dp.callback_query(F.data.startswith("stats_"))
async def show_detailed_stats(callback: types.CallbackQuery):
    """–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
    try:
        user_id = int(callback.data.split("_")[1])
        if user_id != callback.from_user.id:
            await callback.answer("–≠—Ç–æ –Ω–µ –≤–∞—à —Å—á–µ—Ç—á–∏–∫!", show_alert=True)
            return
        
        countdown = get_user_countdown(user_id)
        if not countdown:
            await callback.answer("–°—á–µ—Ç—á–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!", show_alert=True)
            return
        
        days, hours, minutes, seconds = calculate_time_remaining(countdown[4])
        start_date = datetime.fromisoformat(countdown[3])
        end_date = datetime.fromisoformat(countdown[4])
        total_days = countdown[5]
        
        elapsed_days = (datetime.now() - start_date).days
        progress = int(((total_days - days) / total_days) * 100) if total_days > 0 else 100
        
        progress_bar = "‚ñà" * (progress // 10)
        progress_bar += "‚ñë" * (10 - len(progress_bar))
        
        stats_text = (
            f"üìä <b>–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b>\n\n"
            f"üöÄ –ù–∞—á–∞–ª–æ: {start_date.strftime('%d.%m.%Y –≤ %H:%M')}\n"
            f"üèÅ –ö–æ–Ω–µ—Ü: {end_date.strftime('%d.%m.%Y –≤ %H:%M')}\n\n"
            f"‚è∞ –û—Å—Ç–∞–ª–æ—Å—å: <b>{format_time_remaining(days, hours, minutes, seconds)}</b>\n"
            f"üìÖ –ü—Ä–æ—à–ª–æ –¥–Ω–µ–π: {elapsed_days}\n"
            f"üìà –ü—Ä–æ–≥—Ä–µ—Å—Å: [{progress_bar}] {progress}%\n\n"
            f"üîî –í—Ä–µ–º—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: {countdown[7]}"
        )
        
        await callback.message.edit_text(stats_text, reply_markup=callback.message.reply_markup)
        await callback.answer()
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ show_detailed_stats: {e}")
        await callback.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!", show_alert=True)

@dp.callback_query(F.data.startswith("stop_"))
async def stop_countdown_handler(callback: types.CallbackQuery):
    """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç"""
    try:
        user_id = int(callback.data.split("_")[1])
        if user_id != callback.from_user.id:
            await callback.answer("–≠—Ç–æ –Ω–µ –≤–∞—à —Å—á–µ—Ç—á–∏–∫!", show_alert=True)
            return
        
        stop_countdown(user_id)
        
        keyboard = InlineKeyboardMarkup(inline_keyboard=[[
            InlineKeyboardButton(
                text="üóìÔ∏è –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –æ—Ç—Å—á–µ—Ç",
                web_app=WebAppInfo(url=WEB_APP_URL)
            )
        ]])
        
        await callback.message.edit_text(
            "üõë –û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.\n\n"
            "–í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –æ—Ç—Å—á–µ—Ç –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.",
            reply_markup=keyboard
        )
        await callback.answer("–°—á–µ—Ç—á–∏–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ stop_countdown_handler: {e}")
        await callback.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!", show_alert=True)

@dp.message(F.web_app_data)
async def handle_web_app_data(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Web App"""
    logger.info(f"–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ—Ç Web App: {message.web_app_data.data}")
    try:
        data = json.loads(message.web_app_data.data)
        action = data.get("action")
        
        if action == "start_countdown":
            user_id = message.from_user.id
            username = message.from_user.username
            full_name = message.from_user.full_name
            
            days = data.get("days")
            notification_time = data.get("notification_time", "10:00")
            
            if not isinstance(days, (int, float)) or days <= 0:
                await message.answer("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π!")
                return
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å—á–µ—Ç—á–∏–∫, –µ—Å–ª–∏ –µ—Å—Ç—å
            stop_countdown(user_id)
            
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å—á–µ—Ç—á–∏–∫
            save_countdown(user_id, username, full_name, int(days), notification_time)
            
            end_date = datetime.now() + timedelta(days=days)
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É", callback_data=f"stats_{user_id}")],
                [InlineKeyboardButton(text="üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ç—Å—á–µ—Ç", callback_data=f"stop_{user_id}")]
            ])
            
            await message.answer(
                f"‚úÖ <b>–û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç –∑–∞–ø—É—â–µ–Ω!</b>\n\n"
                f"üéØ –¶–µ–ª—å: —á–µ—Ä–µ–∑ {int(days)} {'–¥–µ–Ω—å' if days == 1 else '–¥–Ω—è' if 1 < days < 5 else '–¥–Ω–µ–π'}\n"
                f"üìÖ –î–æ: {end_date.strftime('%d.%m.%Y –≤ %H:%M')}\n"
                f"üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ {notification_time}\n\n"
                f"–Ø –±—É–¥—É –ø—Ä–∏—Å—ã–ª–∞—Ç—å –≤–∞–º –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å —Ç–æ—á–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º –¥–æ —Ü–µ–ª–∏!",
                reply_markup=keyboard
            )
            
        else:
            await message.answer("‚ùå –ü–æ–ª—É—á–µ–Ω—ã –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.")
            
    except json.JSONDecodeError:
        logger.error(f"–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JSON: {message.web_app_data.data}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö.")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ handle_web_app_data: {e}")
        await message.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞.")

# --- Graceful shutdown ---
def signal_handler(signum, frame):
    logger.info(f"–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª {signum}. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...")
    scheduler.shutdown()
    sys.exit(0)

# --- Main Execution ---
async def main():
    if BOT_TOKEN == "YOUR_BOT_TOKEN":
        logger.error("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤–∞—à BOT_TOKEN")
        return
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    init_database()
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
    scheduler.add_job(
        daily_countdown_update,
        CronTrigger(hour=DAILY_NOTIFICATION_HOUR, minute=DAILY_NOTIFICATION_MINUTE),
        id='daily_countdown'
    )
    scheduler.start()
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)
    
    try:
        logger.info("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
        await bot.delete_webhook(drop_pending_updates=True)
        
        bot_info = await bot.get_me()
        logger.info(f"–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω: @{bot_info.username} ({bot_info.full_name})")
        logger.info(f"–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ {DAILY_NOTIFICATION_HOUR:02d}:{DAILY_NOTIFICATION_MINUTE:02d}")
        
        await dp.start_polling(bot, allowed_updates=['message', 'callback_query'])
        
    except asyncio.CancelledError:
        logger.info("–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞")
    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
    finally:
        logger.info("–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–µ—Å—Å–∏–∏ –±–æ—Ç–∞...")
        scheduler.shutdown()
        await bot.session.close()

if __name__ == '__main__':
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ: {e}")
